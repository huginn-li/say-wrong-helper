{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/44181/Downloads/PARA%E7%B3%BB%E7%BB%9F%E4%BB%93%E5%BA%93/B.%E9%A1%B9%E7%9B%AE/sensitive-kimi/my-app/app/api/generate/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\n\r\n// 服务端调用 Kimi API（API Key 不暴露给前端）\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body = await request.json();\r\n    const { targetLabel, sceneLabel, whatWasSaid, fears, severity } = body;\r\n\r\n    // 从环境变量读取 API Key\r\n    const apiKey = process.env.KIMI_API_KEY;\r\n    \r\n    if (!apiKey) {\r\n      return NextResponse.json(\r\n        { error: \"服务器未配置 API Key\", needKey: true },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    // 更严格的系统提示，减少思考痕迹\r\n    const systemPrompt = `你是用户最贴心的闺蜜/兄弟。直接输出三段式回复，不要说任何思考过程、分析、或检查清单。\r\n\r\n【输出格式】\r\n1️⃣ 先抱抱你\r\n（写3-4句话，像朋友一样吐槽+共情，用\"你\"称呼用户）\r\n\r\n2️⃣ 如果补救，你可以说  \r\n轻松版：「自然、带点小自嘲的话，像微信聊天」\r\n真诚版：「简单直接的话，承认+说明」\r\n\r\n3️⃣ 换个角度想\r\n（写2-3句话，让对方觉得这事没那么严重）\r\n\r\n【绝对禁止】\r\n- 禁止出现：思考过程、分析、检查清单、禁止词汇列表\r\n- 禁止出现：\"焦虑X/5\"、\"需要共情\"、\"草稿\"、\"替代表达\"\r\n- 禁止出现：第1点、第2点、或者任何分析性语言\r\n- 话术必须用「」包裹，不要带\"轻松版：\"或\"真诚版：\"前缀\r\n\r\n【正确示例】\r\n1️⃣ 先抱抱你\r\n天啊我太懂你了！那种话一出口就后悔的感觉，简直想当场消失...\r\n\r\n2️⃣ 如果补救，你可以说\r\n「哎呀我刚才嘴比脑子快，你别往心里去啊」\r\n「不好意思，刚那句话我说得不对，我是想说...」\r\n\r\n3️⃣ 换个角度想\r\n其实对方可能根本没注意到，就算注意到了，过几天也就忘了。`;\r\n\r\n    const userPrompt = `场景：${sceneLabel}，对${targetLabel}说错话：\"${whatWasSaid}\"，担心：${fears.join('、')}，焦虑程度${severity}/5。\r\n\r\n直接给我三段式回复，不要说思考过程。`;\r\n\r\n    // 调用 Kimi API\r\n    const response = await fetch('https://api.moonshot.cn/v1/chat/completions', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Authorization': `Bearer ${apiKey}`,\r\n      },\r\n      body: JSON.stringify({\r\n        model: 'kimi-k2.5',\r\n        messages: [\r\n          { role: 'system', content: systemPrompt },\r\n          { role: 'user', content: userPrompt }\r\n        ],\r\n        temperature: 1,\r\n        max_tokens: 500,\r\n      }),\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text();\r\n      console.error('Kimi API Error:', response.status, errorText);\r\n      return NextResponse.json(\r\n        { error: `AI 服务暂时不可用 (${response.status})` },\r\n        { status: 502 }\r\n      );\r\n    }\r\n\r\n    const data = await response.json();\r\n    const message = data.choices[0].message;\r\n    const rawContent = message.content || message.reasoning_content || '';\r\n    \r\n    // 解析响应\r\n    const result = parseKimiResponse(rawContent);\r\n    \r\n    return NextResponse.json(result);\r\n  } catch (error: any) {\r\n    console.error(\"Generate API Error:\", error);\r\n    return NextResponse.json(\r\n      { error: error.message || \"服务器内部错误\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n// 智能解析 - 提取干净的内容\r\nfunction parseKimiResponse(rawContent: string) {\r\n  // 1. 先去掉可能的思考过程（找实际回复开始的位置）\r\n  let content = rawContent;\r\n  \r\n  // 找 \"开始写\"、\"回复\"、\"输出\" 等标记后的内容\r\n  const markers = [\r\n    '开始写：', '开始写:', '输出：', '输出:', '回复：', '回复:',\r\n    '最终结果：', '最终结果:', '【回复】', '【输出】'\r\n  ];\r\n  \r\n  for (const marker of markers) {\r\n    const idx = content.indexOf(marker);\r\n    if (idx !== -1) {\r\n      content = content.substring(idx + marker.length).trim();\r\n      break;\r\n    }\r\n  }\r\n  \r\n  // 2. 去掉代码块标记\r\n  content = content.replace(/```[\\s\\S]*?```/g, '');\r\n  \r\n  // 3. 按行分割并清理\r\n  const lines = content.split('\\n').map(l => l.trim()).filter(l => l);\r\n  \r\n  let comfort = '';\r\n  let 话术A = '';\r\n  let 话术B = '';\r\n  let 重构 = '';\r\n  let currentSection = '';\r\n  \r\n  for (const line of lines) {\r\n    const lowerLine = line.toLowerCase();\r\n    \r\n    // 检测段落标记\r\n    if (line.match(/^1[.、️]\\s*/) || line.includes('抱抱') || line.includes('先抱抱')) {\r\n      currentSection = 'comfort';\r\n      continue;\r\n    }\r\n    if (line.match(/^2[.、️]\\s*/) || line.includes('话术') || line.includes('补救') || line.includes('你可以说')) {\r\n      currentSection = '话术';\r\n      continue;\r\n    }\r\n    if (line.match(/^3[.、️]\\s*/) || line.includes('角度') || line.includes('换个角度')) {\r\n      currentSection = '重构';\r\n      continue;\r\n    }\r\n    \r\n    // 跳过分析性内容\r\n    if (lowerLine.includes('思考') || \r\n        lowerLine.includes('分析') || \r\n        lowerLine.includes('检查') ||\r\n        lowerLine.includes('禁止') ||\r\n        lowerLine.includes('草稿') ||\r\n        lowerLine.includes('焦虑') && lowerLine.includes('/') ||\r\n        lowerLine.includes('需要') && lowerLine.includes('共情') ||\r\n        line.match(/^\\d+[.、]\\s*$/)) {\r\n      continue;\r\n    }\r\n    \r\n    // 收集内容\r\n    if (currentSection === 'comfort') {\r\n      if (!line.match(/^[123]/)) {\r\n        comfort += line + ' ';\r\n      }\r\n    } else if (currentSection === '话术') {\r\n      // 提取引号内容\r\n      const match = line.match(/「([^」]+)」/);\r\n      if (match) {\r\n        if (!话术A) {\r\n          话术A = match[1];\r\n        } else if (!话术B) {\r\n          话术B = match[1];\r\n        }\r\n      }\r\n    } else if (currentSection === '重构') {\r\n      if (!line.match(/^[123]/) && !line.includes('「')) {\r\n        重构 += line + ' ';\r\n      }\r\n    }\r\n  }\r\n  \r\n  // 清理\r\n  comfort = cleanText(comfort);\r\n  重构 = cleanText(重构);\r\n  \r\n  // 组装话术（两个版本合并）\r\n  let 话术 = '';\r\n  if (话术A && 话术B) {\r\n    话术 = `「${话术A}」`;\r\n  } else if (话术A) {\r\n    话术 = `「${话术A}」`;\r\n  } else if (话术B) {\r\n    话术 = `「${话术B}」`;\r\n  }\r\n  \r\n  // 兜底策略\r\n  if (!comfort) {\r\n    for (const line of lines) {\r\n      if (line.length >= 15 && \r\n          !line.includes('「') && \r\n          !line.includes('思考') &&\r\n          !line.includes('分析') &&\r\n          !line.match(/^[123]/)) {\r\n        comfort = line;\r\n        break;\r\n      }\r\n    }\r\n  }\r\n  \r\n  if (!话术) {\r\n    for (const line of lines) {\r\n      const match = line.match(/「([^」]+)」/);\r\n      if (match && match[1].length < 50) {\r\n        话术 = `「${match[1]}」`;\r\n        break;\r\n      }\r\n    }\r\n  }\r\n  \r\n  if (!重构) {\r\n    for (let i = lines.length - 1; i >= 0; i--) {\r\n      const line = lines[i];\r\n      if (line.length >= 20 && \r\n          line.length < 150 &&\r\n          !line.includes('「') && \r\n          !line.match(/^[123]/) &&\r\n          !line.includes('思考')) {\r\n        重构 = line;\r\n        break;\r\n      }\r\n    }\r\n  }\r\n  \r\n  return {\r\n    comfort: comfort || '说错话真的太正常了，谁还没个嘴瓢的时候呢。别太自责了！',\r\n    话术: 话术 || '「哎呀我刚才嘴瓢了，你别往心里去啊」',\r\n    重构: 重构 || '试着换个角度想：对方可能根本没注意到这句话，就算注意到了，过几天也就忘了。'\r\n  };\r\n}\r\n\r\n// 清理文本\r\nfunction cleanText(text: string): string {\r\n  return text\r\n    .replace(/\\s+/g, ' ')\r\n    .replace(/轻松版[：:]?\\s*/gi, '')\r\n    .replace(/真诚版[：:]?\\s*/gi, '')\r\n    .replace(/版本[AB][：:]?\\s*/gi, '')\r\n    .replace(/\\(适合[^)]+\\)/g, '')\r\n    .replace(/[（(]带?有?小?自?嘲?[）)]/g, '')\r\n    .replace(/[（(]简单?直接?[）)]/g, '')\r\n    .trim();\r\n}\r\n"],"names":[],"mappings":"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"}}]
}